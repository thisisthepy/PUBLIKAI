---
// Frontmatter ë¶€ë¶„ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤.
import agedHomesData from './data/agedHomes.json';
import satisfactionData from './data/satisfaction.json';
import renewedHomesData from './data/renewedHomes.json';

const availableYears = Object.keys(agedHomesData.agedHomes).sort((a, b) => b.localeCompare(a));
---

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²œì•ˆì‹œ ë…¸í›„ ì£¼íƒ ì¬ìƒ í”„ë¡œì íŠ¸ í˜„í™©</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f4f7f6; color: #333; display: flex; flex-direction: column; align-items: center; padding: 2rem; margin: 0; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 2rem; }
        .chart-container { width: 100%; max-width: 800px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 1.5rem; margin-bottom: 2rem; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        h2 { font-size: 1.5rem; color: #34495e; border-bottom: 2px solid #eeeeee; padding-bottom: 0.5rem; margin-top: 0; flex-grow: 1; }
        .view-toggle { display: flex; flex-wrap: wrap; }
        .view-toggle button { padding: 0.5rem 1rem; border: 1px solid #ddd; background-color: #f9f9f9; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s, color 0.2s; }
        .view-toggle button:first-of-type { border-radius: 5px 0 0 5px; }
        .view-toggle button:last-of-type { border-radius: 0 5px 5px 0; }
        .view-toggle button:not(:last-child) { border-right: none; }
        .view-toggle button.active { background-color: #3498db; color: white; border-color: #3498db; }
    </style>
</head>
<body>
    <h1>ì²œì•ˆì‹œ ë…¸í›„ ì£¼íƒ ì¬ìƒ í”„ë¡œì íŠ¸ í˜„í™© ğŸ˜ï¸</h1>

    <div class="chart-container">
        <div class="chart-header">
            <h2 id="agedHomesTitle"></h2>
            <div id="agedHomesToggle" class="view-toggle">
                <button data-view="yearly" class="active">ì—°ê°„</button>
                {availableYears.map(year => <button data-view={year}>{year}</button>)}
            </div>
        </div>
        <canvas id="agedHomesChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h2 id="satisfactionTitle"></h2>
            <div id="satisfactionToggle" class="view-toggle">
                <button data-view="yearly" class="active">ì—°ê°„</button>
                {availableYears.map(year => <button data-view={year}>{year}</button>)}
            </div>
        </div>
        <canvas id="satisfactionChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h2 id="renewedHomesTitle"></h2>
            <div id="renewedHomesToggle" class="view-toggle">
                <button data-view="yearly" class="active">ì—°ê°„</button>
                {availableYears.map(year => <button data-view={year}>{year}</button>)}
            </div>
        </div>
        <canvas id="renewedHomesChart"></canvas>
    </div>

    <script define:vars={{ agedHomesData, satisfactionData, renewedHomesData, availableYears }}>
        // --- ì „ì—­ ë³€ìˆ˜ ë° ì¸ìŠ¤í„´ìŠ¤ ---
        let agedHomesChart, satisfactionChart, renewedHomesChart;

        const chartStates = {
            agedHomes: { view: 'yearly' },
            satisfaction: { view: 'yearly' },
            renewedHomes: { view: 'yearly' }
        };
        
        // --- ë°ì´í„° ë³€í™˜ í•¨ìˆ˜ë“¤ì€ ì´ì „ê³¼ ë™ì¼ (ë§¨ ì•„ë˜ì— ì²¨ë¶€) ---
        function transformAgedHomesData(data, view) { /* ... */ }
        function transformSatisfactionData(data, view) { /* ... */ }
        function transformRenewedHomesData(data, view) { /* ... */ }

        // --- ğŸ’¡ ê·¸ë˜í”„ë³„ ê°œë³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ìƒì„± ---
        function updateAgedHomesChart() {
            const view = chartStates.agedHomes.view;
            const data = transformAgedHomesData(agedHomesData, view);
            document.getElementById('agedHomesTitle').innerText = `ğŸ“ˆ ë…¸í›„í™” ì£¼íƒ í˜„í™© (${view === 'yearly' ? 'ì—°ê°„' : view + 'ë…„'})`;
            if (agedHomesChart) { agedHomesChart.data = data; agedHomesChart.update(); } 
            else { agedHomesChart = new Chart(document.getElementById('agedHomesChart'), { type: 'line', data, options: { responsive: true, plugins: { legend: { position: 'top' } } } }); }
        }

        function updateSatisfactionChart() {
            const view = chartStates.satisfaction.view;
            const data = transformSatisfactionData(satisfactionData, view);
            document.getElementById('satisfactionTitle').innerText = `ğŸ˜Š ì‹œë¯¼ ë§Œì¡±ë„ (${view === 'yearly' ? 'ì—°ê°„ ì¢…í•©' : view + 'ë…„ í‰ê· '})`;
            if (satisfactionChart) { satisfactionChart.data = data; satisfactionChart.update(); } 
            else { satisfactionChart = new Chart(document.getElementById('satisfactionChart'), { type: 'pie', data, options: { responsive: true, plugins: { legend: { position: 'top' } } } }); }
        }

        function updateRenewedHomesChart() {
            const view = chartStates.renewedHomes.view;
            const data = transformRenewedHomesData(renewedHomesData, view);
            document.getElementById('renewedHomesTitle').innerText = `ğŸ  ì¬ìƒ ì™„ë£Œ ì£¼íƒ í˜„í™© (${view === 'yearly' ? 'ì—°ê°„' : view + 'ë…„ ëˆ„ì '})`;
            if (renewedHomesChart) { renewedHomesChart.data = data; renewedHomesChart.update(); } 
            else { renewedHomesChart = new Chart(document.getElementById('renewedHomesChart'), { type: 'bar', data, options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } }); }
        }
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í•¨ìˆ˜ ---
        // ğŸ’¡ ê° ì°¨íŠ¸ì— ë§ëŠ” ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •
        function setupEventListeners(chartId, toggleId) {
            const toggleContainer = document.getElementById(toggleId);
            const updaters = {
                agedHomes: updateAgedHomesChart,
                satisfaction: updateSatisfactionChart,
                renewedHomes: updateRenewedHomesChart
            };

            toggleContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const newView = e.target.dataset.view;
                    chartStates[chartId].view = newView;

                    toggleContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');

                    // ğŸ’¡ í•´ë‹¹ ì°¨íŠ¸ì˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë§Œ ì •í™•íˆ í˜¸ì¶œ
                    updaters[chartId]();
                }
            });
        }

        // --- ìµœì´ˆ ì‹¤í–‰ ---
        window.addEventListener('DOMContentLoaded', () => {
            setupEventListeners('agedHomes', 'agedHomesToggle');
            setupEventListeners('satisfaction', 'satisfactionToggle');
            setupEventListeners('renewedHomes', 'renewedHomesToggle');
            
            // ğŸ’¡ ìµœì´ˆ ë¡œë”© ì‹œ, ê° ì°¨íŠ¸ë¥¼ í•œ ë²ˆì”© ê·¸ë ¤ì¤ë‹ˆë‹¤.
            updateAgedHomesChart();
            updateSatisfactionChart();
            updateRenewedHomesChart();
        });

        // --- ë°ì´í„° ë³€í™˜ í•¨ìˆ˜ë“¤ (ì°¸ê³ ìš©) ---
        function transformAgedHomesData(data, view) {const KOR_LABELS = { total: "Total (ì „ì²´)", reported: "Reported (ì‹ ê³ )", inspected: "Inspected (ì ê²€)", resolved: "Resolved (ì¡°ì¹˜ ì™„ë£Œ)" };const COLORS = ['#3498db', '#f1c40f', '#e67e22', '#2ecc71']; const keys = ["total", "reported", "inspected", "resolved"]; if (view !== 'yearly') {const yearData = data.agedHomes[view] || {}; const labels = Object.keys(yearData); const datasets = keys.map((key, index) => ({ label: KOR_LABELS[key], data: labels.map(month => yearData[month][key] || 0), borderColor: COLORS[index], tension: 0.1, fill: false, })); return { labels, datasets };} else {const allYears = Object.keys(data.agedHomes).sort(); const datasets = keys.map((key, index) => ({ label: KOR_LABELS[key], data: allYears.map(yr => Object.values(data.agedHomes[yr]).reduce((sum, monthData) => sum + (monthData[key] || 0), 0)), borderColor: COLORS[index], tension: 0.1, fill: false, })); return { labels: allYears, datasets };}}
        function transformSatisfactionData(data, view) {const labels = ['ê¸ì • (Like)', 'ë¶€ì • (Dislike)', 'ì¤‘ë¦½ (Neutral)']; const backgroundColor = ['#2ecc71', '#e74c3c', '#95a5a6']; if (view !== 'yearly') {const yearData = data.satisfaction[view] || {}; const months = Object.keys(yearData); if (months.length === 0) return { labels: [], datasets: [] }; const total = { like: 0, dislike: 0, neutral: 0 }; months.forEach(month => { total.like += yearData[month].like; total.dislike += yearData[month].dislike; total.neutral += yearData[month].neutral; }); const datasets = [{ data: [total.like / months.length, total.dislike / months.length, total.neutral / months.length], backgroundColor, hoverOffset: 4, }]; return { labels, datasets };} else {const allData = Object.values(data.satisfaction).flatMap(year => Object.values(year)); if (allData.length === 0) return { labels: [], datasets: [] }; const total = { like: 0, dislike: 0, neutral: 0 }; allData.forEach(month => { total.like += month.like; total.dislike += month.dislike; total.neutral += month.neutral; }); const datasets = [{ data: [total.like / allData.length, total.dislike / allData.length, total.neutral / allData.length], backgroundColor, hoverOffset: 4, }]; return { labels, datasets };}}
        function transformRenewedHomesData(data, view) {if (view !== 'yearly') {const yearData = data.renewedHomes[view] || {}; if (Object.keys(yearData).length === 0) return { labels: [], datasets: [] }; const totals = {}; Object.values(yearData).forEach(monthData => { for (const [key, value] of Object.entries(monthData)) { totals[key] = (totals[key] || 0) + value; } }); const labels = Object.keys(totals); const datasets = [{ label: `${view}ë…„ ëˆ„ì  ì™„ë£Œ`, data: Object.values(totals), backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'], }]; return { labels, datasets };} else {const allYears = Object.keys(data.renewedHomes).sort(); const allTypes = [...new Set(allYears.flatMap(year => Object.values(data.renewedHomes[year]).flatMap(month => Object.keys(month))))]; const datasets = allYears.map(year => { const yearTotals = {}; Object.values(data.renewedHomes[year]).forEach(monthData => { for (const [type, count] of Object.entries(monthData)) { yearTotals[type] = (yearTotals[type] || 0) + count; } }); return { label: `${year}ë…„`, data: allTypes.map(type => yearTotals[type] || 0), backgroundColor: `rgba(${Math.floor(Math.random()*150+50)}, ${Math.floor(Math.random()*150+50)}, ${Math.floor(Math.random()*150+50)}, 0.7)` }; }); return { labels: allTypes, datasets };}}
    </script>
</body>
</html>
