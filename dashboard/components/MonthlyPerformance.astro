---
import complaints from '../../data/perfComplaints.json';
import participation from '../../data/perfParticipation.json';
import monthlyBudget from '../../data/monthlyBudget.json'; // ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
import social from '../../data/perfSocial.json';

const YEAR = '2025';
const MONTH_LABELS = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
const MONTH_KEYS   = ['January','February','March','April','May','June','July','August','September','October','November','December'];

// â‘  ì›”ë³„ ë¯¼ì› ê±´ìˆ˜
const received    = MONTH_KEYS.map(m => complaints[YEAR][m]?.received ?? 0);
const inProgress  = MONTH_KEYS.map(m => complaints[YEAR][m]?.in_progress ?? 0);
const resolved    = MONTH_KEYS.map(m => complaints[YEAR][m]?.resolved ?? 0);

// (YTD) ë¯¼ì› ì²˜ë¦¬ìœ¨
const receivedSum = received.reduce((a,b)=>a+b,0);
const resolvedSum = resolved.reduce((a,b)=>a+b,0);
const complaintRate = Math.round((resolvedSum / Math.max(receivedSum,1)) * 1000) / 10; // x.x%

// â‘¡ ì£¼ë¯¼ ì°¸ì—¬ë„ (ë„ë„›: ì°¸ì—¬ vs ë¯¸ì°¸ì—¬)
const eligible = participation[YEAR]?.eligible ?? 1;
const participants = participation[YEAR]?.participants ?? 0;
const nonParticipants = Math.max(eligible - participants, 0);
const participationRate = Math.round((participants/Math.max(eligible,1))*1000)/10; // x.x%

// â‘¢ ì˜ˆì‚° ì§‘í–‰ìœ¨ (ë„ë„›: ì§‘í–‰ vs ë¯¸ì§‘í–‰) - ì›”ë³„ ì˜ˆì‚° JSONì—ì„œ ì§‘ê³„
const allocatedSum = MONTH_KEYS.reduce((s, m) => s + (monthlyBudget[YEAR][m]?.allocated ?? 0), 0);
const spentSum     = MONTH_KEYS.reduce((s, m) => s + (monthlyBudget[YEAR][m]?.spent ?? 0), 0);
const remainSum    = Math.max(allocatedSum - spentSum, 0);
const budgetRate   = Math.round((spentSum / Math.max(allocatedSum, 1)) * 1000) / 10; // ì˜ˆ: 87.3%

// â‘£ í™ë³´/ì†Œí†µ ë°˜ì‘ (ë¼ì¸: ì¡°íšŒìˆ˜)
const views = MONTH_KEYS.map(m => social[YEAR][m]?.views ?? 0);
---

<section class="layout">
  <!-- ì™¼ìª½: 3 ì¹´ë“œ -->
  <div class="left">
    <!-- ì¹´ë“œ 1: ì›”ë³„ ë¯¼ì› ê±´ìˆ˜ -->
    <div class="card big">
      <div class="card__header">
        <h3>ì›”ë³„ ë¯¼ì› ê±´ìˆ˜ ({YEAR})</h3>
      </div>
      <div class="chart-wrap h-240">
        <canvas id="c-complaints"></canvas>
      </div>
    </div>

    <!-- ì¹´ë“œ 2: ì£¼ë¯¼ ì°¸ì—¬ë„ (ë„ë„›) -->
    <div class="card">
      <div class="card__header">
        <h3>ì£¼ë¯¼ ì°¸ì—¬ë„</h3>
        <small class="muted">{Math.round((participants/Math.max(eligible,1))*100)}%</small>
      </div>
      <div class="chart-wrap h-220">
        <canvas id="c-participation"></canvas>
      </div>
      <div class="meta">
        <span>ì°¸ì—¬ {participants.toLocaleString()}ëª…</span>
        <span>ëŒ€ìƒ {eligible.toLocaleString()}ëª…</span>
      </div>
    </div>

    <!-- ì¹´ë“œ 3: ì˜ˆì‚° ì§‘í–‰ìœ¨ (ë„ë„›) -->
    <div class="card">
      <div class="card__header">
        <h3>ì˜ˆì‚° ì§‘í–‰ìœ¨</h3>
        <small class="muted">{budgetRate}%</small>
      </div>
      <div class="chart-wrap h-220">
        <canvas id="c-budget"></canvas>
      </div>
      <div class="meta">
        <span>ì§‘í–‰ {spentSum.toLocaleString()}ì›</span>
        <span>ë°°ì • {allocatedSum.toLocaleString()}ì›</span>
      </div>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½: í™ë³´ ë°˜ì‘ + KPI ë¯¸ë‹ˆ ì¹´ë“œ -->
  <aside class="right">
    <div class="card">
      <div class="card__header">
        <h3>í™ë³´ ë°˜ì‘ (ì¡°íšŒìˆ˜)</h3>
      </div>
      <div class="chart-wrap h-240">
        <canvas id="c-social"></canvas>
      </div>
    </div>

    <!-- ğŸ”¹ ìƒˆë¡œ ì¶”ê°€: í•µì‹¬ ì§€í‘œ ì¹´ë“œ -->
    <div class="card kpi">
      <div class="card__header"><h3>í•µì‹¬ ì§€í‘œ</h3></div>
      <ul class="kpis">
        <li>
          <div class="kpi__top">
            <span class="kpi__label">ë¯¼ì› ì²˜ë¦¬ìœ¨</span>
            <strong class="kpi__value">{complaintRate}%</strong>
          </div>
          <div class="bar"><div class="bar__in" style={`width:${complaintRate}%`}></div></div>
        </li>
        <li>
          <div class="kpi__top">
            <span class="kpi__label">ì°¸ì—¬ìœ¨</span>
            <strong class="kpi__value">{participationRate}%</strong>
          </div>
          <div class="bar"><div class="bar__in" style={`width:${participationRate}%`}></div></div>
        </li>
        <li>
          <div class="kpi__top">
            <span class="kpi__label">ì˜ˆì‚° ì§‘í–‰ìœ¨</span>
            <strong class="kpi__value">{budgetRate}%</strong>
          </div>
          <div class="bar"><div class="bar__in" style={`width:${budgetRate}%`}></div></div>
        </li>
      </ul>
      <div class="kpi__foot">
        <span>ë¯¼ì› {resolvedSum.toLocaleString()}ê±´ ì²˜ë¦¬ / ì ‘ìˆ˜ {receivedSum.toLocaleString()}ê±´</span>
      </div>
    </div>
  </aside>
</section>

<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script is:inline define:vars={{
  MONTH_LABELS, received, inProgress, resolved, 
  participants, nonParticipants,
  spentSum, remainSum,
  views
}}>
  function once(id, make) {
    const el = document.getElementById(id);
    if (!el || el._chart) return;
    el._chart = make(el.getContext('2d'));
  }

  function mount() {
    // 1) ë¯¼ì› ë§‰ëŒ€(ëˆ„ì )
    once('c-complaints', (ctx) => new Chart(ctx, {
      type: 'bar',
      data: {
        labels: MONTH_LABELS,
        datasets: [
          { label: 'ì ‘ìˆ˜',     data: received,   borderWidth: 0, stack: 'a' },
          { label: 'ì²˜ë¦¬ ì¤‘',  data: inProgress, borderWidth: 0, stack: 'a' },
          { label: 'ì²˜ë¦¬ ì™„ë£Œ', data: resolved,   borderWidth: 0, stack: 'a' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { position: 'top' }, tooltip: { mode:'index', intersect:false } },
        scales: {
          x: { grid: { display:false } },
          y: { beginAtZero:true, grid: { display:false }, ticks:{ precision:0 } }
        }
      }
    }));

    // 2) ì°¸ì—¬ë„ ë„ë„›
    once('c-participation', (ctx) => new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['ì°¸ì—¬','ë¯¸ì°¸ì—¬'],
        datasets: [{ data: [participants, nonParticipants] }]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins: { legend:{ position:'bottom' } },
        cutout: '65%'
      }
    }));

    // 3) ì˜ˆì‚° ì§‘í–‰ìœ¨ ë„ë„›
    once('c-budget', (ctx) => new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['ì§‘í–‰','ë¯¸ì§‘í–‰'],
        datasets: [{ data: [spentSum, remainSum] }]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins: { legend:{ position:'bottom' } },
        cutout: '65%'
      }
    }));

    // 4) í™ë³´ ë°˜ì‘ ë¼ì¸
    once('c-social', (ctx) => new Chart(ctx, {
      type: 'line',
      data: { labels: MONTH_LABELS, datasets: [{ label:'ì¡°íšŒìˆ˜', data: views, tension: .3, borderWidth: 2, pointRadius: 0 }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins: { legend:{ display:false } },
        scales: {
          x:{ grid:{ display:false } },
          y:{ beginAtZero:true, grid:{ display:false } }
        }
      }
    }));
  }

  document.addEventListener('astro:page-load', mount);
  document.addEventListener('DOMContentLoaded', mount);
</script>

<style>
  .layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 360px; /* ì™¼ìª½ ë©”ì¸, ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œ */
    gap: 16px;
    align-items: start;
  }

  /* ì™¼ìª½ 2Ã—2 ì¹´ë“œ */
  .left {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 16px;
  }

  .right {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .card {
    width: 100%;
    padding: 14px 16px;
    border-radius: 16px;
    background: #fff;
    border: 1px solid rgba(0,0,0,.06);
  }
  .card.big { grid-column: span 2; } /* ì²« ì¹´ë“œ ê°€ë¡œë¡œ í¬ê²Œ */
  .card__header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .muted { opacity:.6; }
  .meta { display:flex; justify-content:space-between; margin-top:8px; font-size:.85rem; opacity:.8; }

  .chart-wrap { width:100%; height: 220px; }
  .h-220 { height: 220px; }
  .h-240 { height: 260px; }
  canvas { width:100% !important; height:100% !important; background: transparent !important; }

  /* KPI ì¹´ë“œ */
  .kpi .kpis { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:12px; }
  .kpi .kpi__top { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
  .kpi .kpi__label { font-size:.92rem; opacity:.8; }
  .kpi .kpi__value { font-size:1.05rem; }
  .kpi .bar { height:8px; border-radius:999px; background:rgba(0,0,0,.06); overflow:hidden; }
  .kpi .bar__in { height:100%; border-radius:999px; background:linear-gradient(90deg,#60a5fa,#34d399); }
  .kpi .kpi__foot { margin-top:10px; font-size:.85rem; opacity:.7; }

  /* ë°˜ì‘í˜• */
  @media (max-width: 1024px) {
    .layout { grid-template-columns: 1fr; }
    .right { order: 2; }
  }
</style>
