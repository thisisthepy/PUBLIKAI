---
import data from '../../data/monthlyRegeneration.json';

// 고정 연도
const YEAR = '2025';
// 월 라벨(표시용)
const MONTH_LABELS = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
// JSON 키(데이터 참조용)
const MONTH_KEYS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

const started   = MONTH_KEYS.map(m => data[YEAR][m]?.started   ?? 0);
const completed = MONTH_KEYS.map(m => data[YEAR][m]?.completed ?? 0);

// y축 상단에 약간 여유
const suggestedMax = Math.max(...started, ...completed) * 1.2;
---

<section class="card">
  <div class="card__header">
    <h3>월별 재생 현황 ({YEAR}년)</h3>
  </div>

  <!-- 고정 높이 래퍼 -->
  <div class="chart-wrap">
    <canvas id="regenerationChart"></canvas>
  </div>
</section>

<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script is:inline define:vars={{MONTH_LABELS, started, completed, suggestedMax}}>
  function mountRegeneration() {
    const el = document.getElementById('regenerationChart');
    if (!el || el._chart) return;

    el._chart = new Chart(el, {
      type: 'bar',
      data: {
        labels: MONTH_LABELS,
        datasets: [
          {
            type: 'bar',
            label: '착공(건)',
            data: started,
            yAxisID: 'y',
            borderWidth: 0
          },
          {
            type: 'line',
            label: '완료(건)',
            data: completed,
            yAxisID: 'y',
            borderWidth: 2,
            tension: 0.2
          }
        ]
      },
      options: {
        responsive: true,
        // 래퍼 높이에 맞춰 채우기
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { grid: { display: false } },
          y: {
            beginAtZero: true,
            suggestedMax,
            grid: { display: false },
            ticks: { precision: 0 } // 정수 눈금
          }
        },
        plugins: {
          legend: { position: 'top' },
          tooltip: { intersect: false, mode: 'index' }
        }
      }
    });
  }

  // DOM 렌더 이후 실행
  document.addEventListener('astro:page-load', mountRegeneration);
  document.addEventListener('DOMContentLoaded', mountRegeneration);
</script>

<style>
  .card { width: 100%; max-width: 1400px; padding: 1rem 1.25rem; margin: 0 auto 1.5rem; border-radius: 12px; background: transparent; }
  .card__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: .5rem; }
  .card h3 { font-size: 1.1rem; font-weight: 700; margin: 0; }

  /* 고정 높이 래퍼로 세로 길이 제어 */
  .chart-wrap { width: 100%; height: 500px; }
  canvas { width: 100% !important; height: 100% !important; background: transparent !important; }
</style>
