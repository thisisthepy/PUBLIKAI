import requests
from typing import Dict, Any
from datetime import datetime, timedelta
import sys
import os
import re

try:
    from ..utils import web_search
except ImportError:
    parent = os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))
    sys.path.insert(0, parent)
    from utils import web_search


def get_academic_schedule(degree_type: str = "학부") -> str:
    if degree_type == "일반대학원":
        return """
# 2025 일반대학원 학사 일정 (2024.12 ~ 2025.12)

## 12월 (December)
- 12.26(목) ~ 01.02(목): 석ㆍ박사 학위청구논문 원문파일 제출

## 01월 (January)
- 01.01(수): 신정
- 01.07(화) ~ 01.08(수): 석ㆍ박사 학위청구논문 인준파일 제출
- 01.14(화): 2학기 성적발표
- 01.27(월): 임시공휴일
- 01.29(수): 설날
- 01.31(금) ~ 02.03(월): 2025학년도 제1학기 예비수강신청 기간

## 02월 (February)
- 02.03(월) ~ 02.28(금): 휴학 및 복학 신청
- 02.05(수) ~ 02.11(화): 2025학년도 제1학기 수강신청 기간
- 02.25(화): 학위수여식(2024 전기)
- 02.25(화) ~ 02.28(금): 2025학년도 1학기 재학생 등록금 납부
- 02.28(금): 입학식(2025학년도)

## 03월 (March)
- 03.01(토): 3ㆍ1절
- 03.03(월): 대체공휴일
- 03.04(화): 제1학기 개강일
- 03.04(화) ~ 03.10(월): 수강신청 확인 및 변경
- 03.04(화) ~ 03.06(목): 전공시험 원서접수/지도교수제청
- 03.04(화) ~ 03.14(금): 학위청구논문 제출자격 외국어인정서 제출
- 03.17(월): 폐강과목 결정(최종)
- 03.24(월) ~ 03.27(목): 수강신청 취소
- 03.24(월) ~ 03.28(금): 학위청구논문 제출자격 전공시험 실시
- 03.28(금): 수업일수 1/4선

## 04월 (April)
- 04.02(수) ~ 04.04(금): 석ㆍ박사 학위청구논문 접수
- 04.07(월): 수업일수 1/3선
- 04.07(월) ~ 04.11(금): 박사, 석ㆍ박사통합과정 논문지도위원회 구성
- 04.16(수) ~ 04.18(금): 석ㆍ박사 학위청구논문 심사료 납부
- 04.24(목): 수업일수 1/2선

## 05월 (May)
- 05.01(목): 근로자의 날
- 05.02(금) ~ 06.05(목): 석ㆍ박사 학위청구논문 심사
- 05.05(월): 부처님오신날, 어린이날
- 05.06(화): 대체공휴일
- 05.15(목): 수업일수 2/3선
- 05.25(일): 개교기념일
- 05.26(월): 수업일수 3/4선

## 06월 (June)
- 06.06(금): 현충일
- 06.10(화) ~ 06.16(월): 정기휴업일 수업결손 보충강의
- 06.10(화): 석ㆍ박사 학위청구논문 심사 결과 제출
- 06.23(월) ~ 06.27(금): 석ㆍ박사 학위청구논문 원문파일 제출
- 06.24(화): 하기방학

## 07월 (July)
- 07.03(목) ~ 07.04(금): 석ㆍ박사 학위청구논문 인준파일 제출
- 07.11(금): 제1학기 성적발표
- 07.28(월) ~ 07.30(수): 제2학기 예비수강신청

## 08월 (August)
- 08.01(금) ~ 08.29(금): 휴학 및 복학 신청
- 08.04(월) ~ 08.08(금): 제2학기 수강신청
- 08.15(금): 광복절
- 08.25(월): 2024학년도 후기 학위수여식
- 08.26(화) ~ 08.29(금): 2025학년도 제2학기 재학생 등록금 납부

## 09월 (September)
- 09.01(월): 제2학기 개강일
- 09.01(월) ~ 09.03(수): 전공시험 원서접수/지도교수제청
- 09.01(월) ~ 09.05(금): 수강신청 확인 및 변경
- 09.01(월) ~ 09.12(금): 학위청구논문 제출자격 외국어인정서 제출
- 09.12(금): 폐강과목 결정(최종)
- 09.22(월) ~ 09.25(목): 수강신청 취소
- 09.22(월) ~ 09.26(금): 학위청구논문 제출자격시험 실시
- 09.25(목): 수업일수 1/4선

## 10월 (October)
- 10.03(금): 개천절
- 10.06(월): 추석
- 10.08(수): 대체공휴일
- 10.09(목): 한글날
- 10.10(금): 수업일수 1/3선
- 10.10(금) ~ 10.14(화): 석ㆍ박사 학위청구논문 접수
- 10.10(금) ~ 10.14(화): 박사, 석ㆍ박사통합과정 논문지도위원회 구성
- 10.21(화) ~ 10.23(목): 석ㆍ박사 학위청구논문 심사료 납부
- 10.29(수): 수업일수 1/2선

## 11월 (November)
- 11.03(월) ~ 11.28(금): 석ㆍ박사 학위청구논문 심사
- 11.14(금): 수업일수 2/3선
- 11.25(화): 수업일수 3/4선

## 12월 (December)
- 12.03(수): 석ㆍ박사 학위청구논문 심사 결과 제출
- 12.08(월) ~ 12.12(금): 정기휴업일 수업결손 보충강의
- 12.22(월): 동기방학
- 12.25(목): 기독탄신일
- 12.26(금) ~ 01.02(금): 석ㆍ박사 학위청구논문 원문파일 제출

* 자세한 학사일정은 충남대학교 공식 웹사이트를 참고하세요.
충남대학교 홈페이지 대학생활 > 학사안내 > 학사일정
"""
    else:
        return """
# 2025 학부 학사 일정 (2024.12 ~ 2025.12)

## 12월 (December)
- **12.24(화) ~ 01.15(수)**: 동기 계절학기  
- **12.25(목)**: 기독탄신일  
- **12.08(월) ~ 12.12(금)**: 정기휴업일 수업결손 보충강의  
- **12.22(월)**: 동기방학 시작  
- **12.22(월) ~ 01.13(화)**: 동기 계절학기  

## 01월 (January)
- **01.01(수)**: 신정  
- **01.14(화)**: 2학기 성적발표  
- **01.20(월) ~ 01.24(금)**: 학사학위취득유예 신청  
- **01.22(수)**: 동기 계절학기 성적발표  
- **01.22(수) ~ 02.14(금)**: 2025학년도 특별학기(신입학예정자) 수업기간  
- **01.27(월)**: 임시공휴일  
- **01.29(수)**: 설날  
- **01.31(금) ~ 02.03(월)**: 2025학년도 제1학기 예비수강신청 기간  

## 02월 (February)
- **02.03(월) ~ 02.28(금)**: 휴학 및 복학 신청  
- **02.05(수) ~ 02.11(화)**: 2025학년도 제1학기 수강신청  
- **02.25(화)**: 2024 전기 학위수여식  
- **02.25(화) ~ 02.28(금)**: 2025학년도 1학기 재학생 등록금 납부  
- **02.28(금)**: 2025학년도 입학식  

## 03월 (March)
- **03.01(토)**: 3.1절  
- **03.03(월)**: 대체공휴일  
- **03.04(화)**: 제1학기 개강일  
- **03.04(화) ~ 03.10(월)**: 수강신청 확인 및 변경  
- **03.04(화) ~ 03.11(화)**: 학사학위취득 유예 신청 취소  
- **03.04(화) ~ 03.31(월)**: 교육과정 적용연도 및 소속 변경  
- **03.17(월)**: 폐강과목 결정 (최종)  
- **03.24(월) ~ 03.27(목)**: 수강신청 취소  
- **03.28(금)**: 수업일수 1/4선  
- **03.31(월) ~ 04.04(금)**: 조기졸업 신청  

## 04월 (April)
- **04.07(월)**: 수업일수 1/3선  
- **04.07(월) ~ 04.11(금)**: 융복합창의전공 신청ㆍ취소  
- **04.24(목)**: 수업일수 1/2선  

## 05월 (May)
- **05.01(목)**: 근로자의 날  
- **05.05(월)**: 부처님오신날, 어린이날  
- **05.06(화)**: 대체공휴일  
- **05.08(목) ~ 05.12(월)**: 하기 계절학기 수강신청  
- **05.15(목)**: 수업일수 2/3선  
- **05.25(일)**: 개교기념일  
- **05.26(월)**: 수업일수 3/4선  

## 06월 (June)
- **06.06(금)**: 현충일  
- **06.10(화) ~ 06.16(월)**: 정기휴업일 수업결손 보충강의  
- **06.24(화)**: 하기방학  
- **06.24(화) ~ 07.14(월)**: 하기 계절학기  

## 07월 (July)
- **07.11(금)**: 제1학기 성적발표  
- **07.21(월)**: 하기 계절학기 성적발표  
- **07.21(월) ~ 07.25(금)**: 학사학위취득 유예 신청  
- **07.28(월) ~ 07.30(수)**: 제2학기 예비수강신청  

## 08월 (August)
- **08.01(금) ~ 08.29(금)**: 휴학 및 복학 신청  
- **08.04(월) ~ 08.08(금)**: 제2학기 수강신청  
- **08.15(금)**: 광복절  
- **08.25(월)**: 2024학년도 후기 학위수여식  
- **08.26(화) ~ 08.29(금)**: 2025학년도 제2학기 재학생 등록금 납부  

## 09월 (September)
- **09.01(월)**: 제2학기 개강일  
- **09.01(월) ~ 09.05(금)**: 수강신청 확인 및 변경  
- **09.01(월) ~ 09.08(월)**: 학사학위취득 유예 신청 취소  
- **09.01(월) ~ 09.30(화)**: 교육과정 적용연도 및 소속 변경  
- **09.12(금)**: 폐강과목 결정 (최종)  
- **09.22(월) ~ 09.25(목)**: 수강신청 취소  
- **09.25(목)**: 수업일수 1/4선  
- **09.25(목) ~ 10.02(목)**: 조기졸업 신청  

## 10월 (October)
- **10.03(금)**: 개천절  
- **10.06(월)**: 추석  
- **10.08(수)**: 대체공휴일  
- **10.09(목)**: 한글날  
- **10.10(금)**: 수업일수 1/3선  
- **10.13(월) ~ 10.17(금)**: 융복합창의전공 신청ㆍ취소  
- **10.29(수)**: 수업일수 1/2선  

## 11월 (November)
- **11.07(금) ~ 11.11(화)**: 동기 계절학기 수강신청  
- **11.14(금)**: 수업일수 2/3선  
- **11.25(화)**: 수업일수 3/4선  

## 12월 (December)
- **12.08(월) ~ 12.12(금)**: 정기휴업일 수업결손 보충강의  
- **12.22(월)**: 동기방학  
- **12.22(월) ~ 01.13(화)**: 동기 계절학기  
- **12.25(목)**: 기독탄신일

* 자세한 학사일정은 충남대학교 공식 웹사이트를 참고하세요.
충남대학교 홈페이지 대학생활 > 학사안내 > 학사일정
"""


def fetch_academic_schedule_from_web(year: int, degree_type: str = "학부", retry: int = 3) -> str:
    try:
        year = int(year)
    except ValueError:
        return "연도는 숫자로 입력해주세요. 예: 2025"

    url = "https://plus.cnu.ac.kr/_prog/academic_calendar/?site_dvs_cd=kr"
    if degree_type == "일반대학원":
        url += "&menu_dvs_cd=05020102"
    else:
        url += "&menu_dvs_cd=05020101"

    for attempt in range(retry):
        try:
            data = web_search.fetch_webpage(url + f"&year={year}", length_limit=-1)
            if "text_content" in data:
                data = data["text_content"]
                data = "12월 December 12." + data.split("12월 December 12.")[-2]
                data = data.split("페이지 관리자")[0].strip()
                return data
        except requests.RequestException as e:
            print(f"웹 페이지 가져오기 실패: {e}. 재시도 중... ({attempt + 1}/{retry})")
    return "학교 홈페이지가 현재 접속되지 않아 학사일정을 가져오는 데 실패했습니다. 나중에 다시 시도해주세요."


if __name__ == '__main__':
    print("학부 학사일정:")
    print(get_academic_schedule("학부"))

    print("\n일반대학원 학사일정:")
    print(get_academic_schedule("일반대학원"))

    print("\n2025년 학부 최신 학사일정:")
    print(fetch_academic_schedule_from_web(2025, "학부"))

    print("\n2025년 일반대학원 최신 학사일정:")
    print(fetch_academic_schedule_from_web(2025, "일반대학원"))
